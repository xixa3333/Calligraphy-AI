<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calligraphy AI - æ›¸æ³•è¾¨è­˜ç³»çµ±</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
            --text-color: #333;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin: 10px 0; font-size: 1.5rem; }
        
        /* ä¸»è¦å®¹å™¨ */
        .main-container {
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }

        /* åˆ†é æ¨™ç±¤ (Tabs) */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            color: #888;
            transition: 0.3s;
        }
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* å…§å®¹å€å¡Š */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* === ç•«å¸ƒæ¨¡å¼æ¨£å¼ === */
        #canvas-container {
            position: relative;
            width: 100%;
            height: 300px; /* æ‰‹æ©Ÿç‰ˆé«˜åº¦ */
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: white;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•é é¢ */
            overflow: hidden;
        }
        canvas {
            display: block;
            cursor: crosshair;
        }
        .tools {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 8px 12px;
            background: #eee;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .tool-btn.active { background: var(--primary-color); color: white; }
        input[type="range"] { flex: 1; }

        /* === ä¸Šå‚³æ¨¡å¼æ¨£å¼ === */
        .upload-area {
            border: 2px dashed #aaa;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            background: #fafafa;
        }
        .upload-area:hover { background: #f0f8ff; }

        /* === çµæœå€ === */
        #result-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        .prediction { font-size: 1.8rem; color: var(--primary-color); font-weight: bold; margin: 5px 0; }
        .confidence { color: #888; font-size: 0.9rem; }

        /* === é€å‡ºæŒ‰éˆ• === */
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            margin-top: 20px;
            cursor: pointer;
        }
        .submit-btn:active { transform: scale(0.98); }
        .loader { display: none; margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* === è£å‰ªè¦–çª— === */
        #cropper-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; flex-direction: column;
        }
        .cropper-wrapper { flex: 1; overflow: hidden; position: relative; }
        .cropper-actions { padding: 15px; display: flex; justify-content: space-between; background: #222; }
        .c-btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; }
        .btn-cancel { background: #555; color: white; }
        .btn-confirm { background: var(--primary-color); color: white; }
    </style>
</head>
<body>

    <h1>ğŸ–Œï¸ Calligraphy AI</h1>

    <div class="main-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('draw')">âœï¸ æ‰‹å¯«ç•«æ¿</div>
            <div class="tab" onclick="switchTab('upload')">ğŸ“· æ‹ç…§ä¸Šå‚³</div>
        </div>

        <div id="tab-draw" class="tab-content active">
            <div id="canvas-container">
                <canvas id="drawing-board"></canvas>
            </div>
            
            <div class="tools">
                <span>ç­†åˆ·:</span>
                <input type="range" id="brush-size" min="1" max="20" value="8">
                <button class="tool-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> æ¸…é™¤</button>
                <button class="tool-btn active" id="btn-pen" onclick="setTool('pen')">ç­†</button>
                <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">æ“¦</button>
            </div>
        </div>

        <div id="tab-upload" class="tab-content">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-camera fa-3x" style="color:#ccc; margin-bottom:10px;"></i>
                <p>é»æ“Šæ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡</p>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
            </div>
            <img id="upload-preview" src="" style="max-width:100%; display:none; margin-top:10px; border-radius:8px;">
        </div>

        <button class="submit-btn" onclick="submitData()">âœ¨ é–‹å§‹è¾¨è­˜</button>
        <div class="loader" id="loader"></div>

        <div id="result-area" style="display:none;">
            <p style="margin:0; color:#666;">è¾¨è­˜çµæœ</p>
            <div class="prediction" id="pred-text">--</div>
            <div class="confidence" id="conf-text">ä¿¡å¿ƒæ°´æº–: --%</div>
        </div>
    </div>

    <div id="cropper-modal">
        <div class="cropper-wrapper">
            <img id="image-to-crop" src="" style="max-width: 100%;">
        </div>
        <div class="cropper-actions">
            <button class="c-btn btn-cancel" onclick="closeCropper()">é‡é¸</button>
            <button class="c-btn btn-confirm" onclick="confirmCrop()">ç¢ºèªè£å‰ª</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        let currentMode = 'draw'; // 'draw' or 'upload'
        let uploadBlob = null; // å„²å­˜è£å‰ªå¾Œçš„åœ–ç‰‡è³‡æ–™

        // === 1. ç•«æ¿é‚è¼¯ ===
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let brushSize = 8;
        let tool = 'pen'; // 'pen' or 'eraser'

        // åˆå§‹åŒ–ç•«å¸ƒå¤§å° (RWD)
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            ctx.fillStyle = "white"; // èƒŒæ™¯è¨­ç‚ºç™½è‰²
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
        }
        window.addEventListener('resize', resizeCanvas);
        // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿å®¹å™¨å·²æ¸²æŸ“
        setTimeout(resizeCanvas, 100);

        // ç•«ç­†è¨­å®š
        document.getElementById('brush-size').addEventListener('input', (e) => brushSize = e.target.value);

        function setTool(t) {
            tool = t;
            document.getElementById('btn-pen').classList.toggle('active', t === 'pen');
            document.getElementById('btn-eraser').classList.toggle('active', t === 'eraser');
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ç¹ªåœ–äº‹ä»¶ (æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§)
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDraw(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = tool === 'eraser' ? 'white' : 'black';
            ctx.stroke();

            lastX = pos.x;
            lastY = pos.y;
        }

        function endDraw() { isDrawing = false; }

        // ç¶å®šäº‹ä»¶
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mouseout', endDraw);
        
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', endDraw);


        // === 2. ä¸Šå‚³èˆ‡è£å‰ªé‚è¼¯ ===
        const fileInput = document.getElementById('fileInput');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const uploadPreview = document.getElementById('upload-preview');
        let cropper = null;

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imageToCrop.src = evt.target.result;
                    cropperModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.8 });
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });

        function closeCropper() { cropperModal.style.display = 'none'; }

        function confirmCrop() {
            if (!cropper) return;
            // è½‰æˆ DataURL (Base64) æ–¹ä¾¿é¡¯ç¤ºèˆ‡å‚³é€
            const croppedDataUrl = cropper.getCroppedCanvas({
                maxWidth: 800, maxHeight: 800, fillColor: '#fff'
            }).toDataURL('image/jpeg');

            uploadPreview.src = croppedDataUrl;
            uploadPreview.style.display = 'block';
            
            // å„²å­˜é€™å€‹ DataURL æº–å‚™å‚³é€
            uploadBlob = croppedDataUrl; 
            
            closeCropper();
        }


        // === 3. æ•´åˆèˆ‡é€å‡º (ä¿®å¾© 415 éŒ¯èª¤çš„é—œéµ) ===
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if(mode === 'draw') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('tab-draw').classList.add('active');
                setTimeout(resizeCanvas, 50); // åˆ‡æ›å›ä¾†æ™‚é‡ç¹ªä»¥é˜²è·‘ç‰ˆ
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('tab-upload').classList.add('active');
            }
        }

        function submitData() {
            const loader = document.getElementById('loader');
            const resultArea = document.getElementById('result-area');
            const predText = document.getElementById('pred-text');
            const confText = document.getElementById('conf-text');

            let finalImageBase64 = '';

            // åˆ¤æ–·ç•¶å‰æ¨¡å¼ï¼ŒæŠ“å–å°æ‡‰çš„åœ–ç‰‡è³‡æ–™
            if (currentMode === 'draw') {
                // å¾ç•«å¸ƒæŠ“å– Base64
                finalImageBase64 = canvas.toDataURL('image/png');
            } else {
                // å¾ä¸Šå‚³å€æŠ“å–
                if (!uploadBlob) {
                    alert('è«‹å…ˆé¸æ“‡ä¸¦è£å‰ªåœ–ç‰‡');
                    return;
                }
                finalImageBase64 = uploadBlob;
            }

            // é¡¯ç¤ºè®€å–ä¸­
            loader.style.display = 'block';
            resultArea.style.display = 'none';

            // ğŸŒŸ é—œéµä¿®æ­£ï¼šé€™è£¡æ”¹ç”¨ fetch ç™¼é€ JSONï¼Œè§£æ±º 415 éŒ¯èª¤
            // é€™æ¨£ä½ çš„å¾Œç«¯ app.py å¯ä»¥ç¹¼çºŒä½¿ç”¨ request.get_json() æ¥æ”¶ï¼Œä¸ç”¨æ”¹å¾Œç«¯ï¼
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // å‘Šè¨´å¾Œç«¯é€™æ˜¯ JSON
                },
                body: JSON.stringify({
                    image: finalImageBase64 // çµ±ä¸€åŒ…æˆ JSON æ ¼å¼
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                loader.style.display = 'none';
                resultArea.style.display = 'block';
                if (data.error) {
                    predText.innerText = "éŒ¯èª¤";
                    confText.innerText = data.error;
                } else {
                    predText.innerText = `${data.author} (${data.style})`;
                    confText.innerText = `ä¿¡å¿ƒæ°´æº–: ${data.confidence}`;
                }
            })
            .catch(error => {
                loader.style.display = 'none';
                alert('è¾¨è­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\n' + error);
                console.error(error);
            });
        }
    </script>
</body>
</html>