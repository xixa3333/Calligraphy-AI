<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calligraphy AI - 書法辨識系統</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
            --text-color: #333;
            --gold: #ffc107;
            --silver: #aaa;
            --bronze: #cd7f32;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin: 10px 0 5px 0; font-size: 1.5rem; text-align: center; }

        /* 提示訊息樣式 */
        .hint-box {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #ffeeba;
        }
        
        /* 卡片容器 */
        .main-container {
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            /* 修改 1: 稍微放寬最大寬度，避免電腦版字被卡掉 */
            max-width: 600px;
            box-sizing: border-box;
        }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #888; font-weight: bold; }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* 畫布 */
        #canvas-container {
            position: relative; width: 100%; height: 300px;
            border: 2px dashed #ccc; border-radius: 8px; background: white;
            touch-action: none; overflow: hidden;
        }
        canvas { display: block; cursor: crosshair; }
        .tools { display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap; }
        .tool-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; background: #eee; }
        .tool-btn.active { background: var(--primary-color); color: white; }
        input[type="range"] { flex: 1; }

        /* 上傳 */
        .upload-area {
            border: 2px dashed #aaa; padding: 30px; text-align: center;
            border-radius: 8px; cursor: pointer; background: #fafafa;
        }
        #upload-preview { max-width: 100%; display: none; margin-top: 10px; border-radius: 8px; }

        /* === 結果顯示區 === */
        #result-area {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: none; /* 預設隱藏 */
        }
        
        .result-columns {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; 
        }
        
        .result-group {
            flex: 1;
            min-width: 200px; 
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
        }
        
        .result-group h4 {
            margin: 0 0 10px 0;
            text-align: center;
            color: var(--primary-color);
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .rank-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .rank-num {
            width: 25px;
            font-weight: bold;
            text-align: center;
            margin-right: 5px;
            color: #888;
            flex-shrink: 0; /* 防止排名數字被擠壓 */
        }
        /* 前三名顏色 */
        .rank-row:nth-child(1) .rank-num { color: var(--gold); font-size: 1.2rem; }
        .rank-row:nth-child(2) .rank-num { color: var(--silver); font-size: 1.1rem; }
        .rank-row:nth-child(3) .rank-num { color: var(--bronze); font-size: 1.0rem; }

        .rank-name {
            flex: 1;
            font-weight: 600;
            /* 修改 2: 允許文字換行，並移除強制截斷 (...) */
            white-space: normal; 
            line-height: 1.2;
            margin-right: 5px;
        }

        .progress-bg {
            width: 50px; /* 稍微縮小一點進度條寬度，讓文字有更多空間 */
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 0 5px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        .rank-row:nth-child(1) .progress-bar { background: #ff9800; }

        .rank-score {
            width: 45px;
            text-align: right;
            font-size: 0.8rem;
            color: #666;
            font-family: monospace;
            flex-shrink: 0;
        }

        /* 按鈕與讀取 */
        .submit-btn {
            width: 100%; padding: 12px; background: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-size: 1.1rem; margin-top: 20px; cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .submit-btn:active { transform: scale(0.98); }

        .loader { display: none; margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 裁剪視窗 */
        #cropper-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; }
        .cropper-wrapper { flex: 1; overflow: hidden; position: relative; }
        .cropper-actions { padding: 15px; display: flex; justify-content: space-between; background: #222; }
        .c-btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer;}
        .btn-cancel { background: #555; color: white; }
        .btn-confirm { background: var(--primary-color); color: white; }
    </style>
</head>
<body>

    <h1>書法辨識系統</h1>
    
    <div class="hint-box">
        <i class="fas fa-exclamation-circle"></i>
        <span>辨識前請先<strong>裁剪</strong>，且一次僅限輸入<strong>一個字</strong>。</span>
    </div>

    <div class="main-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('draw')">手寫畫板</div>
            <div class="tab" onclick="switchTab('upload')">拍照上傳</div>
        </div>

        <div id="tab-draw" class="tab-content active">
            <div id="canvas-container"><canvas id="drawing-board"></canvas></div>
            <div class="tools">
                <span>筆刷:</span> <input type="range" id="brush-size" min="1" max="20" value="8">
                <button class="tool-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> 清除</button>
                <button class="tool-btn active" id="btn-pen" onclick="setTool('pen')">筆</button>
                <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">擦</button>
            </div>
        </div>

        <div id="tab-upload" class="tab-content">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-camera fa-3x" style="color:#ccc; margin-bottom:10px;"></i>
                <p>點擊拍照或選擇圖片</p>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
            </div>
            <img id="upload-preview" src="">
        </div>

        <button class="submit-btn" onclick="submitData()">開始辨識</button>
        <div class="loader" id="loader"></div>

        <div id="result-area">
            <div class="result-columns">
                <div class="result-group">
                    <h4>書法家預測</h4>
                    <div id="author-list"></div>
                </div>
                <div class="result-group">
                    <h4>字體風格</h4>
                    <div id="style-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="cropper-modal">
        <div class="cropper-wrapper"><img id="image-to-crop" src=""></div>
        <div class="cropper-actions">
            <button class="c-btn btn-cancel" onclick="closeCropper()">重選</button>
            <button class="c-btn btn-confirm" onclick="confirmCrop()">確認</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        let currentMode = 'draw';
        let uploadBlob = null;

        // === 畫布邏輯 ===
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        let isDrawing = false, lastX = 0, lastY = 0, brushSize = 8, tool = 'pen';

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = "round"; ctx.lineJoin = "round";
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        document.getElementById('brush-size').addEventListener('input', (e) => brushSize = e.target.value);
        function setTool(t) {
            tool = t;
            document.getElementById('btn-pen').classList.toggle('active', t === 'pen');
            document.getElementById('btn-eraser').classList.toggle('active', t === 'eraser');
        }
        function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); }
        
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        function startDraw(e) { e.preventDefault(); isDrawing = true; const pos = getPos(e); lastX = pos.x; lastY = pos.y; }
        function draw(e) {
            if (!isDrawing) return; e.preventDefault(); const pos = getPos(e);
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y);
            ctx.lineWidth = brushSize; ctx.strokeStyle = tool === 'eraser' ? 'white' : 'black'; ctx.stroke();
            lastX = pos.x; lastY = pos.y;
        }
        function endDraw() { isDrawing = false; }
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', endDraw);

        // === 裁剪邏輯 ===
        const fileInput = document.getElementById('fileInput');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        let cropper = null;

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imageToCrop.src = evt.target.result;
                    cropperModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.8 });
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });
        function closeCropper() { cropperModal.style.display = 'none'; }
        function confirmCrop() {
            if (!cropper) return;
            const croppedDataUrl = cropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800, fillColor: '#fff' }).toDataURL('image/jpeg');
            document.getElementById('upload-preview').src = croppedDataUrl;
            document.getElementById('upload-preview').style.display = 'block';
            uploadBlob = croppedDataUrl;
            closeCropper();
        }

        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // 修改 3: 切換時隱藏結果區，並清空內容
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('author-list').innerHTML = '';
            document.getElementById('style-list').innerHTML = '';

            if(mode === 'draw') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('tab-draw').classList.add('active');
                setTimeout(resizeCanvas, 50);
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('tab-upload').classList.add('active');
            }
        }

        function submitData() {
            const loader = document.getElementById('loader');
            const resultArea = document.getElementById('result-area');
            
            let finalImageBase64 = currentMode === 'draw' ? canvas.toDataURL('image/png') : uploadBlob;
            if (!finalImageBase64 && currentMode === 'upload') { alert('請先選擇圖片'); return; }

            loader.style.display = 'block';
            resultArea.style.display = 'none';

            fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: finalImageBase64 })
            })
            .then(res => res.json())
            .then(data => {
                loader.style.display = 'none';
                resultArea.style.display = 'block';

                if (data.success) {
                    const renderList = (items) => {
                        return items.map((item, index) => {
                            let name = item.name || "未知";
                            let confStr = item.confidence || "0%";
                            let percentageVal = parseFloat(confStr); 
                            
                            return `
                                <div class="rank-row">
                                    <div class="rank-num">#${index + 1}</div>
                                    <div class="rank-name" title="${name}">${name}</div>
                                    <div class="progress-bg">
                                        <div class="progress-bar" style="width: ${percentageVal}%"></div>
                                    </div>
                                    <div class="rank-score">${confStr}</div>
                                </div>
                            `;
                        }).join('');
                    };

                    document.getElementById('author-list').innerHTML = renderList(data.top3_authors);
                    document.getElementById('style-list').innerHTML = renderList(data.top3_styles);
                } else {
                    alert('錯誤: ' + (data.error || '未知錯誤'));
                }
            })
            .catch(err => {
                loader.style.display = 'none';
                alert('連線失敗: ' + err);
            });
        }
    </script>
</body>
</html>